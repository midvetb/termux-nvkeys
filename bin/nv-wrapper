#!/usr/bin/env bash
set -euo pipefail

# set -x # dbg

_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${_DIR}/.." && pwd)"

PROFILE_NVIM="${ROOT_DIR}/share/termux-nvkeys/profiles/nvim.extra-keys"

TERMUX_DIR="${HOME}/.termux"
TP="${TERMUX_DIR}/termux.properties"

BEGIN_COMMENT="# nv:begin-commented-extra-keys"
END_COMMENT="# nv:end-commented-extra-keys"
BEGIN_NVIM="# nv:begin-nvim-extra-keys"
END_NVIM="# nv:end-nvim-extra-keys"
ORIG_PREFIX="# nv:orig "

_cleaned=0
apply_pid=

die() {
    printf "nv: %s\n" "$*" >&2
    exit 1
}

have() {
    command -v "$1" >/dev/null 2>&1
}

termux_reload() {
    if have termux-reload-settings; then
        termux-reload-settings >/dev/null 2>&1 || true
    fi
}

ensure_files() {
    mkdir -p "$TERMUX_DIR"
    [[ -f "$TP" ]] || : > "$TP"
    [[ -f "$PROFILE_NVIM" ]] || die "missing profile: $PROFILE_NVIM"
}

apply_nvim_keys() {
    local profile tmp
    profile="$(tr -d '\n\r' < "$PROFILE_NVIM")"
    tmp="$(mktemp)"

    awk -v BC="$BEGIN_COMMENT" -v EC="$END_COMMENT" -v OP="$ORIG_PREFIX" '
        BEGIN {
            in_old = 0
        }

        function mark_comment(line) {
            print OP line
        }

        /^[[:space:]]*extra-keys[[:space:]]*=/ && $0 !~ /^[[:space:]]*#/ {
            print BC
            in_old = 1
            mark_comment($0)

            if ($0 ~ /\]\]/) {
                in_old = 0
                print EC
                next
            }

            if ($0 !~ /\\[[:space:]]*$/) {
                in_old = 0
                print EC
            }
            next
        }

        in_old == 1 {
            mark_comment($0)

            if ($0 ~ /\]\]/) {
                in_old = 0
                print EC
                next
            }

            if ($0 !~ /\\[[:space:]]*$/) {
                in_old = 0
                print EC
            }
            next
        }

        {
            print
        }
    ' "$TP" > "$tmp" || die "awk failed while applying nvim keys"

    {
        echo
        echo "$BEGIN_NVIM"
        echo "extra-keys = ${profile}"
        echo "$END_NVIM"
    } >> "$tmp"

    cp -f "$tmp" "$TP"
    rm -rf "$tmp"

    termux_reload
}

restore_extra_keys() {
    local tmp
    tmp="$(mktemp)"

    awk -v BC="$BEGIN_COMMENT" -v EC="$END_COMMENT" -v BN="$BEGIN_NVIM" -v EN="$END_NVIM" -v OP="$ORIG_PREFIX" '
        BEGIN {
            in_uncomment = 0
            in_remove = 0
            op_len = length(OP)
        }

        $0 == BN {
            in_remove = 1
            next
        }

        in_remove == 1 {
            if ($0 == EN) {
                in_remove = 0
            }
            next
        }

        $0 == BC {
            in_uncomment = 1
            next
        }

        $0 == EC {
            in_uncomment = 0
            next
        }

        in_uncomment == 1 {
            if ($0 !~ /^[[:space:]]*#/) {
                # Non-comment line found inside a comment block â€”
                # likely a manual user edit; print as-is and stop uncommenting
                in_uncomment = 0
                print
                next
            }

            if (index($0, OP) == 1) {
                print substr($0, op_len + 1)
            } else {
                # Keep original commented lines untouched
                print
            }
            next
        }

        {
            print
        }
    ' "$TP" > "$tmp" || { printf "nv: awk failed during restore, properties unchanged\n" >&2; return 1; }

    cp -f "$tmp" "$TP"
    rm -rf "$tmp"

    termux_reload
}

cleanup() {
    [[ $_cleaned -eq 1 ]] && return
    _cleaned=1

    if [[ -n "$apply_pid" ]] && kill -0 "$apply_pid" 2>/dev/null; then
        wait "$apply_pid" 2>/dev/null || true
    fi

    restore_extra_keys || true
}

main() {
    ensure_files

    apply_nvim_keys &
    apply_pid=$!

    trap cleanup EXIT INT TERM

    if have nvim; then
        nvim "$@"
    else
        die "nvim not found"
    fi
}

main "$@"
